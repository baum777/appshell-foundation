name: Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Build Job
  build:
    name: Build for Deployment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Production
        run: npm run build
        env:
          NODE_ENV: production

      - name: Create Build Info
        run: |
          echo "{
            \"version\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"buildDate\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"branch\": \"${{ github.ref_name }}\"
          }" > dist/build-info.json

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 30

  # Deployment zu Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.tradeapp.example.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/

      - name: Deploy to Staging
        run: |
          echo "üöÄ Deployment zu Staging..."
          echo "Hier w√ºrde das Deployment zu Vercel/Netlify/AWS stattfinden"
          
          # Beispiel f√ºr Vercel:
          # npm install -g vercel
          # vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
          
          # Beispiel f√ºr Netlify:
          # npm install -g netlify-cli
          # netlify deploy --prod --dir=dist --auth=${{ secrets.NETLIFY_TOKEN }}

      - name: Run Smoke Tests
        run: |
          echo "üß™ Smoke Tests auf Staging..."
          # Hier w√ºrden kritische E2E Tests gegen Staging laufen

      - name: Notify Slack (optional)
        if: always()
        run: |
          echo "üì¢ W√ºrde Slack-Notification senden"
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Staging deployment completed"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

  # Deployment zu Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://tradeapp.example.com
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: dist/

      - name: Deploy to Production
        run: |
          echo "üöÄ Deployment zu Production..."
          echo "Hier w√ºrde das Deployment zu Vercel/Netlify/AWS stattfinden"

      - name: Run Smoke Tests
        run: |
          echo "üß™ Smoke Tests auf Production..."
          # Hier w√ºrden kritische E2E Tests gegen Production laufen

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## Changes in this Release
            - See commit history for details
            
            ## Deployment Info
            - Environment: Production
            - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - Commit: ${{ github.sha }}
          draft: false
          prerelease: false

      - name: Notify Team
        if: always()
        run: |
          echo "üì¢ Production Deployment abgeschlossen!"
          # Hier w√ºrden Notifications an Team-Kan√§le gehen

  # Rollback Job (manuell ausl√∂sbar)
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Rollback
        run: |
          echo "‚è™ Rollback zu vorheriger Version..."
          echo "Implementierung h√§ngt vom Hosting-Provider ab"
